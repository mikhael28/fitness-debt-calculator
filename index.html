<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fitness Debt Ledger</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Georgia", "Times New Roman", serif;
        background: #e8e4d9;
        background-image: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.02) 2px,
          rgba(0, 0, 0, 0.02) 4px
        );
        padding: 20px;
        max-width: 600px;
        margin: 0 auto;
        color: #1a1a1a;
      }

      .header-seal {
        text-align: center;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(to bottom, #1a365d 0%, #2c5282 100%);
        border: 3px solid #b8860b;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
      }

      .header-seal::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          to right,
          transparent,
          #b8860b,
          transparent
        );
      }

      .header-seal::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          to right,
          transparent,
          #b8860b,
          transparent
        );
      }

      .department-title {
        font-size: 11px;
        letter-spacing: 3px;
        text-transform: uppercase;
        color: #b8860b;
        margin-bottom: 8px;
        font-weight: normal;
      }

      .ledger-title {
        font-size: 28px;
        font-weight: bold;
        color: #f7f7f7;
        letter-spacing: 1px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 8px;
      }

      .ledger-subtitle {
        font-size: 10px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: #cbd5e0;
        font-weight: normal;
      }

      .debt-display {
        background: #f7fafc;
        border: 2px solid #2d3748;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .balance-row {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 10px;
      }

      .balance-item {
        flex: 1;
        max-width: 250px;
      }

      .balance-label {
        font-size: 9px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: #718096;
        margin-bottom: 8px;
      }

      .debt-amount {
        font-size: 48px;
        font-weight: bold;
        color: #c53030;
        font-family: "Courier New", monospace;
        letter-spacing: 2px;
        margin: 5px 0;
      }

      .credit-amount {
        font-size: 48px;
        font-weight: bold;
        color: #2f855a;
        font-family: "Courier New", monospace;
        letter-spacing: 2px;
        margin: 5px 0;
      }

      .balance-unit {
        font-size: 11px;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: #4a5568;
      }

      .container {
        background: #fefefe;
        border: 2px solid #2d3748;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        position: relative;
      }

      .container::before {
        content: "";
        position: absolute;
        top: 5px;
        left: 5px;
        right: 5px;
        bottom: 5px;
        border: 1px solid #cbd5e0;
        pointer-events: none;
      }

      h2 {
        color: #1a365d;
        margin-bottom: 15px;
        font-size: 16px;
        border-bottom: 2px solid #2d3748;
        padding-bottom: 8px;
        letter-spacing: 1px;
        text-transform: uppercase;
        font-weight: bold;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #2d3748;
        font-weight: bold;
        font-size: 12px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #4a5568;
        background: #f7fafc;
        font-size: 14px;
        font-family: "Courier New", monospace;
        color: #1a1a1a;
      }

      input[type="number"] {
        appearance: textfield;
        -moz-appearance: textfield;
      }

      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #1a365d;
        background: #fff;
      }

      button {
        width: 100%;
        padding: 12px;
        border: 2px solid #2d3748;
        font-size: 13px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: Georgia, serif;
        box-shadow: 0 2px 0 rgba(0, 0, 0, 0.1);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background: #2c5282;
        color: #f7f7f7;
      }

      .btn-primary:hover {
        background: #1a365d;
      }

      .btn-success {
        background: #2f855a;
        color: #f7f7f7;
      }

      .btn-success:hover {
        background: #276749;
      }

      .btn-secondary {
        background: #4a5568;
        color: #f7f7f7;
        margin-top: 10px;
      }

      .btn-secondary:hover {
        background: #2d3748;
      }

      .transaction-list {
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #cbd5e0;
        padding: 10px;
        background: #f7fafc;
      }

      .transaction-item {
        padding: 12px;
        border-left: 4px solid #cbd5e0;
        margin-bottom: 10px;
        background: #fff;
        font-size: 13px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .transaction-item.debt {
        border-left-color: #c53030;
        background: #fff5f5;
      }

      .transaction-item.payment {
        border-left-color: #2f855a;
        background: #f0fff4;
      }

      .transaction-item.system {
        border-left-color: #dd6b20;
        background: #fffaf0;
      }

      .transaction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .transaction-amount {
        font-weight: bold;
        font-size: 16px;
        font-family: "Courier New", monospace;
      }

      .transaction-amount.negative {
        color: #c53030;
      }

      .transaction-amount.positive {
        color: #2f855a;
      }

      .transaction-description {
        color: #4a5568;
        font-size: 12px;
      }

      .transaction-time {
        color: #718096;
        font-size: 11px;
        font-family: "Courier New", monospace;
      }

      .exercise-config {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }

      .exercise-config label {
        margin: 0;
      }

      .exercise-config input {
        padding: 8px;
      }

      .info-box {
        background: #fffaf0;
        border: 2px solid #dd6b20;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #744210;
        letter-spacing: 0.3px;
      }

      .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 20px;
        border: 2px solid #2d3748;
        background: #2d3748;
      }

      .tab {
        flex: 1;
        padding: 14px 10px;
        background: #4a5568;
        border: none;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        color: #cbd5e0;
        text-transform: uppercase;
        letter-spacing: 1px;
        border-right: 1px solid #2d3748;
        font-family: Georgia, serif;
        transition: all 0.2s;
      }

      .tab:last-child {
        border-right: none;
      }

      .tab.active {
        background: #1a365d;
        color: #b8860b;
      }

      .tab:hover:not(.active) {
        background: #2d3748;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .quick-add-section {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px dashed #cbd5e0;
      }

      .quick-add-title {
        font-size: 12px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .exercise-quick-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 10px;
        background: #f7fafc;
        border: 1px solid #cbd5e0;
      }

      .exercise-name {
        font-size: 13px;
        font-weight: bold;
        color: #2d3748;
        flex: 1;
      }

      .quick-buttons {
        display: flex;
        gap: 8px;
      }

      .quick-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #2f855a;
        background: #f0fff4;
        color: #2f855a;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Courier New", monospace;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 0;
      }

      .quick-btn:hover {
        background: #2f855a;
        color: white;
        transform: scale(1.05);
      }

      .quick-btn:active {
        transform: scale(0.95);
      }

      .stamp {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 60px;
        height: 60px;
        border: 3px solid rgba(197, 48, 48, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: rotate(-15deg);
        pointer-events: none;
      }

      .stamp-text {
        font-size: 9px;
        font-weight: bold;
        color: rgba(197, 48, 48, 0.3);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        pointer-events: none;
      }

      .toast {
        background: #2f855a;
        color: white;
        padding: 12px 20px;
        margin-bottom: 10px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-size: 13px;
        font-weight: bold;
        letter-spacing: 0.5px;
        animation: slideIn 0.3s ease-out, slideOut 0.3s ease-in 2.7s;
        pointer-events: auto;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      .quick-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #cbd5e0;
        border-color: #a0aec0;
        color: #718096;
      }

      .quick-btn:disabled:hover {
        background: #cbd5e0;
        color: #718096;
        transform: scale(1);
      }

      /* Modal overlay and container */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
      }

      .modal-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-content {
        background: #fefefe;
        border: 3px solid #2d3748;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        animation: slideDown 0.3s ease-out;
        position: relative;
      }

      .modal-header {
        background: linear-gradient(to bottom, #c53030 0%, #9b2c2c 100%);
        border-bottom: 3px solid #2d3748;
        padding: 20px;
        text-align: center;
      }

      .modal-title {
        font-size: 24px;
        font-weight: bold;
        color: #f7f7f7;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .modal-subtitle {
        font-size: 11px;
        color: #fed7d7;
        letter-spacing: 1px;
        margin-top: 5px;
      }

      .modal-body {
        padding: 25px;
      }

      .rollover-summary {
        background: #f7fafc;
        border: 2px solid #cbd5e0;
        padding: 20px;
        margin-bottom: 20px;
      }

      .rollover-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        font-size: 14px;
        color: #2d3748;
      }

      .rollover-line.total {
        border-top: 2px solid #2d3748;
        margin-top: 10px;
        padding-top: 15px;
        font-weight: bold;
        font-size: 16px;
      }

      .rollover-label {
        flex: 1;
      }

      .rollover-value {
        font-family: "Courier New", monospace;
        font-weight: bold;
        color: #c53030;
      }

      .rollover-value.old {
        color: #718096;
        text-decoration: line-through;
      }

      .rollover-value.new {
        color: #c53030;
        font-size: 18px;
      }

      .modal-warning {
        background: #fffaf0;
        border: 2px solid #dd6b20;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #744210;
        line-height: 1.6;
      }

      .modal-button {
        width: 100%;
        padding: 15px;
        background: #2c5282;
        color: #f7f7f7;
        border: 2px solid #2d3748;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: Georgia, serif;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s;
      }

      .modal-button:hover {
        background: #1a365d;
      }

      .modal-button:active {
        transform: translateY(1px);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Debug Panel */
      .debug-toggle {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 60px;
        height: 60px;
        background: #2d3748;
        color: white;
        border: 2px solid #4a5568;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        z-index: 9998;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .debug-toggle:hover {
        background: #4a5568;
      }

      .debug-panel {
        position: fixed;
        bottom: 90px;
        left: 20px;
        width: 350px;
        max-height: 500px;
        overflow-y: auto;
        background: #1a202c;
        color: #e2e8f0;
        border: 2px solid #4a5568;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        z-index: 9998;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        display: none;
      }

      .debug-panel.show {
        display: block;
      }

      .debug-panel h3 {
        color: #48bb78;
        font-size: 13px;
        margin-bottom: 10px;
        border-bottom: 1px solid #4a5568;
        padding-bottom: 5px;
      }

      .debug-line {
        padding: 3px 0;
        line-height: 1.5;
      }

      .debug-label {
        color: #90cdf4;
      }

      .debug-value {
        color: #fbd38d;
      }

      .debug-button {
        width: 100%;
        padding: 8px;
        margin-top: 8px;
        background: #2c5282;
        color: white;
        border: 1px solid #4a5568;
        cursor: pointer;
        font-size: 11px;
        font-family: "Courier New", monospace;
      }

      .debug-button:hover {
        background: #2b6cb0;
      }

      .debug-log {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #4a5568;
        max-height: 150px;
        overflow-y: auto;
      }

      .debug-log-entry {
        padding: 2px 0;
        color: #cbd5e0;
        font-size: 10px;
      }

      .debug-log-entry.error {
        color: #fc8181;
      }

      .debug-log-entry.success {
        color: #68d391;
      }

      /* Refresh button */
      .refresh-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        background: #f7fafc;
        border: 2px solid #4a5568;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        opacity: 0.7;
      }

      .refresh-btn:hover {
        opacity: 1;
        background: #e2e8f0;
        transform: scale(1.05);
      }

      .refresh-btn:active {
        transform: scale(0.95);
      }

      .refresh-btn.spinning {
        animation: spin 0.6s linear;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .refresh-icon {
        font-size: 18px;
        line-height: 1;
      }
    </style>
  </head>
  <body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Debug Panel -->
    <button
      class="debug-toggle"
      onclick="toggleDebugPanel()"
      title="Toggle Debug Panel"
    >
      üêõ
    </button>
    <div class="debug-panel" id="debugPanel">
      <h3>DEBUG PANEL</h3>
      <div id="debugContent"></div>
      <button class="debug-button" onclick="toggleTestMode()">
        Toggle Test Mode
      </button>
      <button class="debug-button" onclick="setYesterdayDate()">
        Set Date to Yesterday
      </button>
      <button class="debug-button" onclick="forceRolloverTest()">
        Force Rollover (Test)
      </button>
      <button class="debug-button" onclick="clearDebugLog()">Clear Log</button>
      <div class="debug-log" id="debugLog"></div>
    </div>

    <!-- Day Rollover Modal -->
    <div class="modal-overlay" id="rolloverModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">‚ö†Ô∏è DAY END REPORT ‚ö†Ô∏è</div>
          <div class="modal-subtitle" id="modalSubtitle">New Day Detected</div>
        </div>
        <div class="modal-body">
          <div class="modal-warning">
            <strong>NOTICE:</strong> One or more days have passed since your
            last session. Management fees and debt penalties have been
            automatically applied per your debt agreement.
          </div>
          <div class="rollover-summary" id="rolloverSummary">
            <!-- Dynamically populated -->
          </div>
          <button class="modal-button" onclick="closeRolloverModal()">
            Acknowledge & Continue
          </button>
        </div>
      </div>
    </div>

    <div class="header-seal">
      <div class="department-title">Department of Physical Treasury</div>
      <div class="ledger-title">DEBT LEDGER</div>
    </div>

    <div class="debt-display">
      <button
        id="refreshBtn"
        class="refresh-btn"
        onclick="refreshFromCloud()"
        title="Sync from cloud"
        style="display: none"
      >
        <span class="refresh-icon">‚Üª</span>
      </button>
      <div class="balance-row">
        <div class="balance-item">
          <div class="balance-label">Outstanding Debt</div>
          <div class="debt-amount" id="debtAmount">0</div>
          <div class="balance-unit">RMB</div>
        </div>
        <div class="balance-item">
          <div class="balance-label">Daily Credit</div>
          <div class="credit-amount" id="creditAmount">0</div>
          <div class="balance-unit">RMB (Resets Nightly)</div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('exercise')">
        Exercise
      </button>
      <button class="tab" onclick="switchTab('transactions')">
        Transactions
      </button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <div id="exerciseTab" class="tab-content active">
      <div class="container">
        <div>
          <div class="exercise-quick-item">
            <div class="exercise-name">Push-ups</div>
            <div class="quick-buttons">
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'pushups', 10)"
              >
                10
              </button>
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'pushups', 20)"
              >
                20
              </button>
            </div>
          </div>

          <div class="exercise-quick-item">
            <div class="exercise-name">Sit-ups</div>
            <div class="quick-buttons">
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'situps', 10)"
              >
                10
              </button>
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'situps', 20)"
              >
                20
              </button>
            </div>
          </div>

          <div class="exercise-quick-item">
            <div class="exercise-name">Curls</div>
            <div class="quick-buttons">
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'curls', 10)"
              >
                10
              </button>
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'curls', 20)"
              >
                20
              </button>
            </div>
          </div>

          <div class="exercise-quick-item">
            <div class="exercise-name">Bench Press</div>
            <div class="quick-buttons">
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'bench', 10)"
              >
                10
              </button>
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'bench', 20)"
              >
                20
              </button>
            </div>
          </div>

          <div class="exercise-quick-item">
            <div class="exercise-name">Plank</div>
            <div class="quick-buttons">
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'plank', 1)"
              >
                1m
              </button>
              <button
                type="button"
                class="quick-btn"
                onclick="quickAdd(this, 'plank', 2)"
              >
                2m
              </button>
            </div>
          </div>
        </div>
        <form id="exerciseForm" class="quick-add-section">
          <div class="form-group">
            <label for="exerciseType">Exercise Type</label>
            <select id="exerciseType" required>
              <option value="">Select exercise...</option>
              <option value="pushups">Push-ups</option>
              <option value="situps">Sit-ups</option>
              <option value="curls">Curls</option>
              <option value="bench">Bench Press</option>
              <option value="plank">Plank (minutes)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="exerciseAmount">Amount</label>
            <input
              type="number"
              id="exerciseAmount"
              step="0.1"
              min="0"
              placeholder="0"
              required
            />
          </div>
          <button type="submit" class="btn-success">Record Exercise</button>
        </form>
      </div>
    </div>

    <div id="transactionsTab" class="tab-content">
      <div class="container">
        <h2>Add Purchase</h2>
        <div class="info-box">
          NOTICE: Purchases cost 7 RMB per USD. Daily credit (if available) is
          used first with no penalty. Credit purchases (when in debt) incur
          double cost penalty. Credit resets to zero every night.
        </div>
        <form id="purchaseForm">
          <div class="form-group">
            <label for="purchaseDesc">Description</label>
            <input
              type="text"
              id="purchaseDesc"
              placeholder="e.g., Beer, Pizza"
              required
            />
          </div>
          <div class="form-group">
            <label for="purchaseAmount">Amount (USD)</label>
            <input
              type="number"
              id="purchaseAmount"
              step="0.01"
              min="0"
              placeholder="0.00"
              required
            />
          </div>
          <button type="submit" class="btn-primary">Add Purchase</button>
        </form>
      </div>

      <div class="container">
        <h2>Transaction History</h2>
        <div class="transaction-list" id="transactionList">
          <p style="text-align: center; color: #718096; font-size: 12px">
            No transactions recorded
          </p>
        </div>
      </div>
    </div>

    <div id="settingsTab" class="tab-content">
      <div class="container">
        <h2>Exercise Values</h2>
        <p style="margin-bottom: 15px; color: #4a5568; font-size: 12px">
          Configure RMB value per exercise unit
        </p>

        <div class="exercise-config">
          <label>Push-ups (per rep)</label>
          <input type="number" id="valuePushups" value="1" min="0" step="0.1" />
        </div>

        <div class="exercise-config">
          <label>Sit-ups (per rep)</label>
          <input type="number" id="valueSitups" value="1" min="0" step="0.1" />
        </div>

        <div class="exercise-config">
          <label>Curls (per rep)</label>
          <input type="number" id="valueCurls" value="1" min="0" step="0.1" />
        </div>

        <div class="exercise-config">
          <label>Bench Press (per rep)</label>
          <input type="number" id="valueBench" value="1" min="0" step="0.1" />
        </div>

        <div class="exercise-config">
          <label>Plank (per minute)</label>
          <input type="number" id="valuePlank" value="30" min="0" step="0.1" />
        </div>

        <button class="btn-secondary" onclick="saveExerciseValues()">
          Save Values
        </button>
      </div>

      <div class="container">
        <h2>Cloud Sync</h2>

        <div class="info-box">
          <strong>How it works:</strong><br />
          ‚Ä¢ Choose a unique key (like "misha" or "john123")<br />
          ‚Ä¢ Your debt auto-saves to cloud after each transaction<br />
          ‚Ä¢ Use same key on other devices to sync your data
        </div>

        <div class="form-group">
          <label for="appKeyInput">Your Cloud Key</label>
          <input
            type="text"
            id="appKeyInput"
            placeholder="e.g., misha"
            maxlength="20"
          />
        </div>

        <button
          class="btn-success"
          onclick="saveAndSyncAppKey()"
          style="margin-bottom: 10px"
        >
          Start Using This Key
        </button>

        <div
          style="
            font-size: 11px;
            color: #718096;
            text-align: center;
            margin-bottom: 15px;
          "
        >
          Status: <span id="syncStatus">Not configured</span>
        </div>

        <div style="border-top: 1px dashed #cbd5e0; padding-top: 15px">
          <div
            style="
              font-size: 11px;
              color: #2d3748;
              font-weight: bold;
              margin-bottom: 8px;
              text-transform: uppercase;
            "
          >
            Advanced
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
            <!-- <button class="btn-secondary" onclick="syncToCloud()" style="margin-top: 0; font-size: 11px; padding: 10px;">Manual Sync</button> -->
            <button
              class="btn-secondary"
              onclick="loadFromCloud()"
              style="margin-top: 0; font-size: 11px; padding: 10px"
            >
              Pull from Cloud
            </button>
          </div>
        </div>
      </div>

      <div class="container">
        <h2>System Parameters</h2>
        <div style="font-size: 12px; line-height: 1.8; color: #2d3748">
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 10px;
              margin-bottom: 15px;
            "
          >
            <div><strong>Exchange Rate:</strong></div>
            <div>1 USD = 7 RMB</div>
            <div><strong>Management Fee:</strong></div>
            <div>50 RMB daily</div>
            <div><strong>Debt Penalty:</strong></div>
            <div>2x overnight</div>
            <div><strong>Credit Penalty:</strong></div>
            <div>2x purchase cost</div>
            <div><strong>Credit Rollover:</strong></div>
            <div>None (resets nightly)</div>
          </div>
        </div>
        <button class="btn-secondary" onclick="resetApp()">
          Reset All Data
        </button>
      </div>
    </div>

    <script>
      // State management
      let state = {
        debt: 0,
        credit: 0,
        lastCheckDate: null,
        transactions: [],
        exerciseValues: {
          pushups: 1,
          situps: 1,
          curls: 1,
          bench: 1,
          plank: 30,
        },
        appKey: "",
        lastSyncTime: null,
      };

      // Rollover tracking (for modal display)
      let rolloverData = null;

      // Test mode flag (bypasses cloud sync for testing)
      let testMode = false;

      // Constants
      const USD_TO_RMB = 7;
      const MGMT_FEE = 50;

      // Exercise type display names
      const typeNames = {
        pushups: "Push-ups",
        situps: "Sit-ups",
        curls: "Curls",
        bench: "Bench Press",
        plank: "Plank",
      };

      // Initialize app
      async function init() {
        debugLog("üöÄ App initializing...", "success");
        loadState();
        debugLog(
          `Loaded state: debt=${state.debt}, credit=${state.credit}, lastCheckDate=${state.lastCheckDate}`
        );
        await checkDayRollover();
        updateDisplay();
        loadExerciseValues();
        loadAppKey();
        updateSyncStatus();
        updateDebugPanel();

        // Start periodic day check (every 60 seconds)
        startDayMonitor();
        debugLog("‚úì Day monitor started (checks every 60s)", "success");
      }

      // Monitor for day changes while app is open
      function startDayMonitor() {
        setInterval(async () => {
          const today = getDateString();
          debugLog(
            `‚è∞ Monitor check: today=${today}, lastCheckDate=${state.lastCheckDate}`
          );
          if (state.lastCheckDate && state.lastCheckDate !== today) {
            debugLog("üîî Day change detected! Applying rollover...", "success");
            await checkDayRollover();
            updateDisplay();
            updateDebugPanel();
          }
        }, 60000); // Check every 60 seconds
      }

      // LocalStorage functions
      function loadState() {
        const saved = localStorage.getItem("fitnessDebtState");
        if (saved) {
          state = JSON.parse(saved);
        } else {
          state.lastCheckDate = getDateString();
          saveState();
        }
      }

      function saveState() {
        localStorage.setItem("fitnessDebtState", JSON.stringify(state));
      }

      // Cloud sync functions
      async function saveAndSyncAppKey() {
        const appKey = document.getElementById("appKeyInput").value.trim();

        if (!appKey) {
          alert(
            'Please enter a cloud key first.\n\nExample: "misha" or "john123"'
          );
          return;
        }

        // Validate key (alphanumeric, no spaces)
        if (!/^[a-zA-Z0-9]+$/.test(appKey)) {
          alert(
            "Cloud key must contain only letters and numbers (no spaces or special characters)."
          );
          return;
        }

        state.appKey = appKey;
        saveState();
        updateSyncStatus();
        updateRefreshButton();

        // First, try to PULL from cloud to see if this key already exists
        try {
          const response = await fetch(
            `https://keyvalue.immanuel.co/api/KeyVal/GetValue/${appKey}/fitnessdebt`
          );
          const cloudData = await response.text();

          console.log("Checking if key exists in cloud:", cloudData);

          // If data exists in cloud, load it first
          if (cloudData && cloudData !== "null" && cloudData !== "") {
            // Strip surrounding quotes if present (API returns "value" instead of value)
            const cleanData = cloudData.replace(/^"(.*)"$/, "$1");
            const parts = cleanData.split("|");
            if (parts.length === 3) {
              const debt = parseFloat(parts[0]);
              const credit = parseFloat(parts[1]);
              const lastCheckDate = parts[2];

              if (!isNaN(debt) && !isNaN(credit) && lastCheckDate) {
                // Found existing data! Load it
                state.debt = debt;
                state.credit = credit;
                state.lastCheckDate = lastCheckDate;
                state.lastSyncTime = new Date().toISOString();
                saveState();
                updateDisplay();
                updateSyncStatus();

                alert(
                  'Cloud sync activated!\n\nKey: "' +
                    appKey +
                    '"\n\nFound existing data in cloud:\nDebt: ' +
                    debt.toFixed(0) +
                    " RMB\nCredit: " +
                    credit.toFixed(0) +
                    " RMB\nLast rollover: " +
                    lastCheckDate +
                    "\n\nYour debt will now auto-sync after each transaction."
                );
                return;
              }
            } else if (parts.length === 2) {
              // Legacy format (debt|lastCheckDate)
              const debt = parseFloat(parts[0]);
              const lastCheckDate = parts[1];

              if (!isNaN(debt) && lastCheckDate) {
                // Found existing data! Load it
                state.debt = debt;
                state.credit = 0;
                state.lastCheckDate = lastCheckDate;
                state.lastSyncTime = new Date().toISOString();
                saveState();
                updateDisplay();
                updateSyncStatus();

                alert(
                  'Cloud sync activated!\n\nKey: "' +
                    appKey +
                    '"\n\nFound existing data in cloud (legacy format):\nDebt: ' +
                    debt.toFixed(0) +
                    " RMB\nLast rollover: " +
                    lastCheckDate +
                    "\n\nYour debt will now auto-sync after each transaction."
                );
                return;
              }
            }
          }

          // No existing data found, sync current state to cloud
          const synced = await syncToCloud();

          if (synced) {
            alert(
              'Cloud sync activated!\n\nYour key: "' +
                appKey +
                '"\n\nThis is a new key. Your current debt (' +
                state.debt.toFixed(0) +
                " RMB) has been synced to cloud.\n\nYour debt will now auto-sync after each transaction."
            );
          } else {
            alert(
              "Cloud key saved, but sync failed. Check your internet connection."
            );
          }
        } catch (error) {
          console.error("Error checking cloud:", error);
          alert(
            "Error checking cloud. Key saved locally, but could not verify cloud data."
          );
        }
      }

      async function syncToCloud() {
        if (!state.appKey) {
          return false;
        }

        try {
          // Create sync value: debt|credit|lastCheckDate (pipe-delimited for simplicity)
          const debtValue = Math.round(state.debt);
          const creditValue = Math.round(state.credit);
          const syncValue = `${debtValue}|${creditValue}|${state.lastCheckDate}`;

          console.log("Syncing to cloud:", syncValue);

          const response = await fetch(
            `https://keyvalue.immanuel.co/api/KeyVal/UpdateValue/${state.appKey}/fitnessdebt/${syncValue}`,
            { method: "POST" }
          );

          console.log("Sync response status:", response.status);

          if (response.ok) {
            state.lastSyncTime = new Date().toISOString();
            saveState();
            updateSyncStatus();
            console.log("Sync successful:", syncValue);
            return true;
          } else {
            console.error("Sync failed with status:", response.status);
            return false;
          }
        } catch (error) {
          console.error("Sync error:", error);
          return false;
        }
      }

      async function syncFromCloudSilent() {
        // Silent sync from cloud (used during init to prevent duplicate rollovers)
        if (!state.appKey) return false;

        try {
          const response = await fetch(
            `https://keyvalue.immanuel.co/api/KeyVal/GetValue/${state.appKey}/fitnessdebt`
          );
          const cloudData = await response.text();

          if (cloudData && cloudData !== "null" && cloudData !== "") {
            // Strip surrounding quotes if present (API returns "value" instead of value)
            const cleanData = cloudData.replace(/^"(.*)"$/, "$1");
            // Parse pipe-delimited format: debt|credit|lastCheckDate or debt|lastCheckDate (legacy)
            const parts = cleanData.split("|");
            if (parts.length === 3) {
              const debt = parseFloat(parts[0]);
              const credit = parseFloat(parts[1]);
              const lastCheckDate = parts[2];

              if (!isNaN(debt) && !isNaN(credit) && lastCheckDate) {
                state.debt = debt;
                state.credit = credit;
                state.lastCheckDate = lastCheckDate;
                state.lastSyncTime = new Date().toISOString();
                saveState();
                updateDisplay();
                updateSyncStatus();
                return true;
              }
            } else if (parts.length === 2) {
              // Legacy format (debt|lastCheckDate)
              const debt = parseFloat(parts[0]);
              const lastCheckDate = parts[1];

              if (!isNaN(debt) && lastCheckDate) {
                state.debt = debt;
                state.credit = 0;
                state.lastCheckDate = lastCheckDate;
                state.lastSyncTime = new Date().toISOString();
                saveState();
                updateDisplay();
                updateSyncStatus();
                return true;
              }
            }
          }
        } catch (error) {
          console.error("Silent sync error:", error);
        }
        return false;
      }

      async function loadFromCloud() {
        // Allow loading even if key isn't saved yet - use whatever is in the input field
        const appKey =
          state.appKey || document.getElementById("appKeyInput").value.trim();

        if (!appKey) {
          alert("Please enter your cloud key first.");
          return;
        }

        try {
          const response = await fetch(
            `https://keyvalue.immanuel.co/api/KeyVal/GetValue/${appKey}/fitnessdebt`
          );
          const cloudData = await response.text();

          console.log("Loaded from cloud:", cloudData);

          if (cloudData && cloudData !== "null" && cloudData !== "") {
            // Strip surrounding quotes if present (API returns "value" instead of value)
            const cleanData = cloudData.replace(/^"(.*)"$/, "$1");
            // Parse pipe-delimited format: debt|credit|lastCheckDate or debt|lastCheckDate (legacy)
            const parts = cleanData.split("|");
            if (parts.length === 3) {
              const debt = parseFloat(parts[0]);
              const credit = parseFloat(parts[1]);
              const lastCheckDate = parts[2];

              if (!isNaN(debt) && !isNaN(credit) && lastCheckDate) {
                const oldDebt = state.debt;
                const oldCredit = state.credit;
                state.debt = debt;
                state.credit = credit;
                state.lastCheckDate = lastCheckDate;

                // Save the app key if it wasn't already saved
                if (!state.appKey) {
                  state.appKey = appKey;
                }

                state.lastSyncTime = new Date().toISOString();
                saveState();
                updateDisplay();
                updateSyncStatus();

                // Update the input field
                document.getElementById("appKeyInput").value = appKey;

                alert(
                  "Success!\n\nLoaded from cloud:\nOld debt: " +
                    oldDebt.toFixed(0) +
                    " RMB\nNew debt: " +
                    debt.toFixed(0) +
                    " RMB\nOld credit: " +
                    oldCredit.toFixed(0) +
                    " RMB\nNew credit: " +
                    credit.toFixed(0) +
                    " RMB\nLast rollover: " +
                    lastCheckDate
                );
              } else {
                alert("Invalid data format in cloud.");
              }
            } else if (parts.length === 2) {
              // Legacy format (debt|lastCheckDate)
              const debt = parseFloat(parts[0]);
              const lastCheckDate = parts[1];

              if (!isNaN(debt) && lastCheckDate) {
                const oldDebt = state.debt;
                state.debt = debt;
                state.credit = 0;
                state.lastCheckDate = lastCheckDate;

                // Save the app key if it wasn't already saved
                if (!state.appKey) {
                  state.appKey = appKey;
                }

                state.lastSyncTime = new Date().toISOString();
                saveState();
                updateDisplay();
                updateSyncStatus();

                // Update the input field
                document.getElementById("appKeyInput").value = appKey;

                alert(
                  "Success!\n\nLoaded from cloud (legacy format):\nOld debt: " +
                    oldDebt.toFixed(0) +
                    " RMB\nNew debt: " +
                    debt.toFixed(0) +
                    " RMB\nLast rollover: " +
                    lastCheckDate
                );
              } else {
                alert("Invalid data format in cloud.");
              }
            } else {
              alert("Invalid data format in cloud. Received: " + cloudData);
            }
          } else {
            alert(
              'No debt data found in cloud for key "' +
                appKey +
                '".\n\nThis might be a new key. Your next transaction will sync automatically.'
            );
          }
        } catch (error) {
          alert("Error loading from cloud: " + error.message);
        }
      }

      async function refreshFromCloud() {
        if (!state.appKey) {
          return;
        }

        const refreshBtn = document.getElementById("refreshBtn");
        if (refreshBtn) {
          refreshBtn.classList.add("spinning");
        }

        try {
          const response = await fetch(
            `https://keyvalue.immanuel.co/api/KeyVal/GetValue/${state.appKey}/fitnessdebt`
          );
          const cloudData = await response.text();

          console.log("Refreshing from cloud:", cloudData);

          if (cloudData && cloudData !== "null" && cloudData !== "") {
            const cleanData = cloudData.replace(/^"(.*)"$/, "$1");
            const parts = cleanData.split("|");
            if (parts.length === 3) {
              const debt = parseFloat(parts[0]);
              const credit = parseFloat(parts[1]);
              const lastCheckDate = parts[2];

              if (!isNaN(debt) && !isNaN(credit) && lastCheckDate) {
                // Check if data is different
                if (
                  state.debt !== debt ||
                  state.credit !== credit ||
                  state.lastCheckDate !== lastCheckDate
                ) {
                  state.debt = debt;
                  state.credit = credit;
                  state.lastCheckDate = lastCheckDate;
                  state.lastSyncTime = new Date().toISOString();
                  saveState();
                  updateDisplay();
                  updateSyncStatus();
                  showToast("‚úì Synced from cloud");
                } else {
                  showToast("‚úì Already up to date");
                }
              }
            } else if (parts.length === 2) {
              // Legacy format
              const debt = parseFloat(parts[0]);
              const lastCheckDate = parts[1];

              if (!isNaN(debt) && lastCheckDate) {
                if (
                  state.debt !== debt ||
                  state.lastCheckDate !== lastCheckDate
                ) {
                  state.debt = debt;
                  state.credit = 0;
                  state.lastCheckDate = lastCheckDate;
                  state.lastSyncTime = new Date().toISOString();
                  saveState();
                  updateDisplay();
                  updateSyncStatus();
                  showToast("‚úì Synced from cloud");
                } else {
                  showToast("‚úì Already up to date");
                }
              }
            }
          }
        } catch (error) {
          console.error("Refresh error:", error);
          showToast("‚úó Sync failed");
        }

        // Remove spinning animation
        setTimeout(() => {
          if (refreshBtn) {
            refreshBtn.classList.remove("spinning");
          }
        }, 600);
      }

      function loadAppKey() {
        if (state.appKey) {
          document.getElementById("appKeyInput").value = state.appKey;
        }
      }

      function updateSyncStatus() {
        const statusEl = document.getElementById("syncStatus");
        if (!statusEl) return;

        if (!state.appKey) {
          statusEl.textContent = "Not configured";
          statusEl.style.color = "#718096";
        } else if (state.lastSyncTime) {
          const syncDate = new Date(state.lastSyncTime);
          const now = new Date();
          const diffMinutes = Math.floor((now - syncDate) / 1000 / 60);

          if (diffMinutes < 1) {
            statusEl.textContent = "Synced just now";
            statusEl.style.color = "#2f855a";
          } else if (diffMinutes < 60) {
            statusEl.textContent = `Synced ${diffMinutes} min ago`;
            statusEl.style.color = "#2f855a";
          } else {
            const hours = Math.floor(diffMinutes / 60);
            statusEl.textContent = `Synced ${hours}h ago`;
            statusEl.style.color = "#718096";
          }
        } else {
          statusEl.textContent = "Never synced";
          statusEl.style.color = "#c53030";
        }
      }

      // Date utilities
      function getDateString() {
        // Use LOCAL timezone instead of UTC to prevent rollover at wrong time
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function getTimeString() {
        const now = new Date();
        return now.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Day rollover logic
      async function checkDayRollover() {
        const today = getDateString();
        const lastDate = state.lastCheckDate;

        debugLog(
          `üìÖ checkDayRollover: today=${today}, lastCheckDate=${lastDate}`
        );

        // If we have an app key and a day has passed, check cloud first (unless in test mode)
        if (state.appKey && lastDate && lastDate !== today && !testMode) {
          debugLog("‚òÅÔ∏è Cloud sync enabled, checking cloud first...");
          await syncFromCloudSilent();
        } else if (testMode) {
          debugLog("üß™ TEST MODE: Skipping cloud sync check");
        }

        // Re-check after potential cloud sync
        const currentLastDate = state.lastCheckDate;
        debugLog(
          `After cloud check: currentLastDate=${currentLastDate}, today=${getDateString()}`
        );

        if (currentLastDate && currentLastDate !== today) {
          // Calculate days passed
          const last = new Date(currentLastDate);
          const current = new Date(today);
          const daysPassed = Math.floor(
            (current - last) / (1000 * 60 * 60 * 24)
          );

          debugLog(`üìÖ Days passed: ${daysPassed}`, "success");

          // Capture initial state before any rollovers
          const initialDebt = state.debt;
          const initialCredit = state.credit;
          const rolloverDetails = [];

          debugLog(
            `Starting rollover: debt=${initialDebt}, credit=${initialCredit}`
          );

          for (let i = 0; i < daysPassed; i++) {
            const beforeDebt = state.debt;
            const beforeCredit = state.credit;
            debugLog(
              `Day ${
                i + 1
              }: Before - debt=${beforeDebt}, credit=${beforeCredit}`
            );
            applyDayEnd();
            debugLog(
              `Day ${i + 1}: After - debt=${state.debt}, credit=${
                state.credit
              }`,
              "success"
            );
            rolloverDetails.push({
              beforeDebt,
              beforeCredit,
              afterDebt: state.debt,
              afterCredit: state.credit,
              mgmtFee: MGMT_FEE,
            });
          }

          state.lastCheckDate = today;
          saveState();

          // Sync after day rollover
          syncToCloud();

          // Show modal with rollover summary
          debugLog(
            `üìä Showing rollover modal: ${daysPassed} day(s), debt ${initialDebt} ‚Üí ${state.debt}`,
            "success"
          );
          showRolloverModal(
            daysPassed,
            initialDebt,
            initialCredit,
            state.debt,
            state.credit,
            rolloverDetails
          );
        } else if (!currentLastDate || currentLastDate !== today) {
          debugLog("First time setup detected");
          // First time setup or date mismatch
          state.lastCheckDate = today;
          saveState();
        } else {
          debugLog("‚úì No rollover needed - same day", "success");
        }
      }

      function applyDayEnd() {
        const oldDebt = state.debt;
        const oldCredit = state.credit;

        // Step 1: Double yesterday's debt
        let newDebt = state.debt * 2;

        // Step 2: Add today's management fee (not doubled)
        newDebt += MGMT_FEE;

        state.debt = newDebt;
        state.credit = 0; // Reset credit every night

        // Add system transaction
        let description = `Day end: debt doubled (${oldDebt.toFixed(
          0
        )} √ó 2 = ${(oldDebt * 2).toFixed(0)}), then +${MGMT_FEE} mgmt fee`;
        if (oldCredit > 0) {
          description += `, ${oldCredit.toFixed(0)} RMB credit forfeited`;
        }

        state.transactions.unshift({
          type: "system",
          description: description,
          amount: newDebt - oldDebt,
          time: "Midnight",
          date: state.lastCheckDate,
        });
      }

      // Purchase form handler
      document
        .getElementById("purchaseForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const desc = document.getElementById("purchaseDesc").value;
          const usd = parseFloat(
            document.getElementById("purchaseAmount").value
          );

          let baseCost = usd * USD_TO_RMB;
          let totalCost = baseCost;
          let usedCredit = 0;
          let addedDebt = 0;
          let doubled = false;

          // First, try to use credit (no penalty)
          if (state.credit >= baseCost) {
            // Full purchase covered by credit
            state.credit -= baseCost;
            usedCredit = baseCost;
          } else if (state.credit > 0) {
            // Partial credit available
            usedCredit = state.credit;
            state.credit = 0;
            let remaining = baseCost - usedCredit;

            // If already in debt, double the remaining cost
            if (state.debt > 0) {
              remaining *= 2;
              doubled = true;
            }

            state.debt += remaining;
            addedDebt = remaining;
            totalCost = usedCredit + addedDebt;
          } else {
            // No credit, use debt
            if (state.debt > 0) {
              // Already in debt, double the cost
              totalCost = baseCost * 2;
              doubled = true;
            }
            state.debt += totalCost;
            addedDebt = totalCost;
          }

          let transactionDesc = desc;
          if (usedCredit > 0 && addedDebt > 0) {
            transactionDesc += ` (${usedCredit.toFixed(
              0
            )} RMB from credit, ${addedDebt.toFixed(0)} RMB to debt)`;
          } else if (usedCredit > 0) {
            transactionDesc += " (paid with credit)";
          }

          if (doubled) {
            transactionDesc += " [CREDIT PENALTY APPLIED]";
          }

          state.transactions.unshift({
            type: "debt",
            description: transactionDesc,
            amount: totalCost,
            usd: usd,
            time: getTimeString(),
            date: getDateString(),
            doubled: doubled,
          });

          saveState();
          updateDisplay();
          syncToCloud(); // Auto-sync to cloud

          // Reset form
          this.reset();
        });

      // Exercise form handler
      document
        .getElementById("exerciseForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const type = document.getElementById("exerciseType").value;
          const amount = parseFloat(
            document.getElementById("exerciseAmount").value
          );

          recordExercise(type, amount);

          // Reset form
          this.reset();
        });

      // Toast notification function
      function showToast(message) {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Quick add function
      function quickAdd(button, type, amount) {
        // Disable the button
        button.disabled = true;

        // Store original styles
        const originalBg = button.style.background;
        const originalColor = button.style.color;
        const originalBorderColor = button.style.borderColor;

        // Record the exercise
        recordExercise(type, amount);

        // Show toast notification
        const unit = type === "plank" ? "min" : "reps";
        showToast(`‚úì Recorded ${amount} ${unit} of ${typeNames[type]}`);

        // Re-enable button after 3 seconds and reset styles
        setTimeout(() => {
          button.disabled = false;
          button.style.background = originalBg;
          button.style.color = originalColor;
          button.style.borderColor = originalBorderColor;
        }, 3000);
      }

      // Shared exercise recording function
      function recordExercise(type, amount) {
        const value = state.exerciseValues[type];
        const rmb = amount * value;
        const unit = type === "plank" ? "min" : "reps";

        let description = `${typeNames[type]} (${amount} ${unit})`;

        if (state.debt > 0) {
          // Pay off debt first
          const payment = Math.min(rmb, state.debt);
          state.debt -= payment;

          const surplus = rmb - payment;
          if (surplus > 0) {
            // Add surplus to credit
            state.credit += surplus;
            description += ` (-${payment.toFixed(
              0
            )} RMB debt, +${surplus.toFixed(0)} RMB credit)`;
          } else {
            description += ` (-${payment.toFixed(0)} RMB debt)`;
          }
        } else {
          // No debt, add to credit
          state.credit += rmb;
          description += ` (+${rmb.toFixed(0)} RMB credit)`;
        }

        state.transactions.unshift({
          type: "payment",
          description: description,
          amount: rmb,
          time: getTimeString(),
          date: getDateString(),
        });

        saveState();
        updateDisplay();
        syncToCloud(); // Auto-sync to cloud
      }

      // Display updates
      function updateDisplay() {
        document.getElementById("debtAmount").textContent =
          state.debt.toFixed(0);
        document.getElementById("creditAmount").textContent =
          state.credit.toFixed(0);
        updateTransactionList();
        updateRefreshButton();
      }

      function updateRefreshButton() {
        const refreshBtn = document.getElementById("refreshBtn");
        if (refreshBtn) {
          if (state.appKey) {
            refreshBtn.style.display = "flex";
          } else {
            refreshBtn.style.display = "none";
          }
        }
      }

      function updateTransactionList() {
        const list = document.getElementById("transactionList");

        if (state.transactions.length === 0) {
          list.innerHTML =
            '<p style="text-align: center; color: #718096; font-size: 12px;">No transactions recorded</p>';
          return;
        }

        list.innerHTML = state.transactions
          .map((t) => {
            const isNegative = t.type === "debt" || t.type === "system";
            const sign = isNegative ? "+" : "-";
            const amountClass = isNegative ? "negative" : "positive";

            let desc = t.description;
            if (t.type === "debt" && t.usd) {
              desc += ` ($${t.usd.toFixed(2)} USD)`;
              if (t.doubled) {
                desc += " [CREDIT PENALTY APPLIED]";
              }
            }

            return `
                    <div class="transaction-item ${t.type}">
                        <div class="transaction-header">
                            <span class="transaction-amount ${amountClass}">${sign}${t.amount.toFixed(
              0
            )} RMB</span>
                            <span class="transaction-time">${t.time}</span>
                        </div>
                        <div class="transaction-description">${desc}</div>
                    </div>
                `;
          })
          .join("");
      }

      // Exercise values
      function loadExerciseValues() {
        document.getElementById("valuePushups").value =
          state.exerciseValues.pushups;
        document.getElementById("valueSitups").value =
          state.exerciseValues.situps;
        document.getElementById("valueCurls").value =
          state.exerciseValues.curls;
        document.getElementById("valueBench").value =
          state.exerciseValues.bench;
        document.getElementById("valuePlank").value =
          state.exerciseValues.plank;
      }

      function saveExerciseValues() {
        state.exerciseValues.pushups = parseFloat(
          document.getElementById("valuePushups").value
        );
        state.exerciseValues.situps = parseFloat(
          document.getElementById("valueSitups").value
        );
        state.exerciseValues.curls = parseFloat(
          document.getElementById("valueCurls").value
        );
        state.exerciseValues.bench = parseFloat(
          document.getElementById("valueBench").value
        );
        state.exerciseValues.plank = parseFloat(
          document.getElementById("valuePlank").value
        );

        saveState();
        alert("Exercise values saved successfully.");
      }

      // Tab switching
      function switchTab(tab) {
        // Update tab buttons
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");

        // Update tab content
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        if (tab === "transactions") {
          document.getElementById("transactionsTab").classList.add("active");
        } else if (tab === "exercise") {
          document.getElementById("exerciseTab").classList.add("active");
        } else if (tab === "settings") {
          document.getElementById("settingsTab").classList.add("active");
        }
      }

      // Reset app
      function resetApp() {
        if (
          confirm("WARNING: This will permanently delete all records. Proceed?")
        ) {
          localStorage.removeItem("fitnessDebtState");
          location.reload();
        }
      }

      // Modal functions
      function showRolloverModal(
        daysPassed,
        initialDebt,
        initialCredit,
        finalDebt,
        finalCredit,
        details
      ) {
        const modal = document.getElementById("rolloverModal");
        const subtitle = document.getElementById("modalSubtitle");
        const summary = document.getElementById("rolloverSummary");

        // Update subtitle
        if (daysPassed === 1) {
          subtitle.textContent = "1 Day Has Passed";
        } else {
          subtitle.textContent = `${daysPassed} Days Have Passed`;
        }

        // Build summary HTML
        let summaryHTML = "";

        // Show each day's rollover if multiple days
        if (daysPassed > 1) {
          details.forEach((day, index) => {
            const doubled = day.beforeDebt * 2;
            summaryHTML += `
              <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #cbd5e0;">
                <div style="font-weight: bold; margin-bottom: 8px; color: #2d3748;">Day ${
                  index + 1
                }:</div>
                <div class="rollover-line">
                  <span class="rollover-label">Starting Debt:</span>
                  <span class="rollover-value">${day.beforeDebt.toFixed(
                    0
                  )} RMB</span>
                </div>
                <div class="rollover-line">
                  <span class="rollover-label">√ó Overnight Penalty (2x):</span>
                  <span class="rollover-value">${doubled.toFixed(0)} RMB</span>
                </div>
                <div class="rollover-line">
                  <span class="rollover-label">+ Daily Management Fee:</span>
                  <span class="rollover-value">+${day.mgmtFee} RMB</span>
                </div>
                <div class="rollover-line">
                  <span class="rollover-label">Ending Debt:</span>
                  <span class="rollover-value">${day.afterDebt.toFixed(
                    0
                  )} RMB</span>
                </div>
                ${
                  day.beforeCredit > 0
                    ? `<div class="rollover-line">
                  <span class="rollover-label">Credit Forfeited:</span>
                  <span class="rollover-value">-${day.beforeCredit.toFixed(
                    0
                  )} RMB</span>
                </div>`
                    : ""
                }
              </div>
            `;
          });
        }

        // Show overall summary
        summaryHTML += `
          <div class="rollover-line">
            <span class="rollover-label">Your Debt on ${
              state.lastCheckDate
            }:</span>
            <span class="rollover-value old">${initialDebt.toFixed(
              0
            )} RMB</span>
          </div>
          ${
            initialCredit > 0
              ? `<div class="rollover-line">
            <span class="rollover-label">Credit Forfeited:</span>
            <span class="rollover-value">-${initialCredit.toFixed(0)} RMB</span>
          </div>`
              : ""
          }
          <div class="rollover-line total">
            <span class="rollover-label">New Debt Today:</span>
            <span class="rollover-value new">${finalDebt.toFixed(0)} RMB</span>
          </div>
        `;

        summary.innerHTML = summaryHTML;

        // Show modal with animation
        modal.classList.add("show");
      }

      function closeRolloverModal() {
        const modal = document.getElementById("rolloverModal");
        modal.classList.remove("show");
      }

      // Debug Panel Functions
      function toggleDebugPanel() {
        const panel = document.getElementById("debugPanel");
        panel.classList.toggle("show");
        if (panel.classList.contains("show")) {
          updateDebugPanel();
        }
      }

      function updateDebugPanel() {
        const content = document.getElementById("debugContent");
        const today = getDateString();
        const now = new Date().toLocaleTimeString();

        content.innerHTML = `
          <div class="debug-line">
            <span class="debug-label">üß™ Test Mode:</span>
            <span class="debug-value" style="color: ${
              testMode ? "#68d391" : "#cbd5e0"
            }">${testMode ? "ENABLED" : "disabled"}</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Current Time:</span>
            <span class="debug-value">${now}</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Today's Date:</span>
            <span class="debug-value">${today}</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Last Check Date:</span>
            <span class="debug-value">${state.lastCheckDate || "null"}</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Debt:</span>
            <span class="debug-value">${state.debt.toFixed(2)} RMB</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Credit:</span>
            <span class="debug-value">${state.credit.toFixed(2)} RMB</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">App Key:</span>
            <span class="debug-value">${state.appKey || "none"}</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Transactions:</span>
            <span class="debug-value">${state.transactions.length}</span>
          </div>
          <div class="debug-line">
            <span class="debug-label">Day Match:</span>
            <span class="debug-value">${
              state.lastCheckDate === today ? "‚úì SAME" : "‚úó DIFFERENT"
            }</span>
          </div>
        `;
      }

      function debugLog(message, type = "info") {
        console.log(`[DEBUG] ${message}`);

        const logDiv = document.getElementById("debugLog");
        if (!logDiv) return;

        const entry = document.createElement("div");
        entry.className = `debug-log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;

        logDiv.insertBefore(entry, logDiv.firstChild);

        // Keep only last 50 entries
        while (logDiv.children.length > 50) {
          logDiv.removeChild(logDiv.lastChild);
        }
      }

      function clearDebugLog() {
        const logDiv = document.getElementById("debugLog");
        if (logDiv) {
          logDiv.innerHTML = "";
        }
        debugLog("Log cleared", "success");
      }

      function forceRolloverTest() {
        debugLog("üß™ FORCE ROLLOVER TEST initiated", "success");
        debugLog(
          `Before: debt=${state.debt}, credit=${state.credit}, lastCheckDate=${state.lastCheckDate}`
        );

        // Enable test mode to bypass cloud sync
        testMode = true;
        debugLog("Test mode ENABLED (bypassing cloud sync)");
        updateDebugPanel();

        // Force trigger rollover check
        checkDayRollover().then(() => {
          updateDisplay();
          updateDebugPanel();
          debugLog("‚úì Force rollover completed", "success");

          // Disable test mode after a delay
          setTimeout(() => {
            testMode = false;
            debugLog("Test mode disabled");
            updateDebugPanel();
          }, 2000);
        });
      }

      function setYesterdayDate() {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split("T")[0];

        // Enable test mode
        testMode = true;
        debugLog("üß™ Test mode ENABLED");

        debugLog(`Setting lastCheckDate to ${yesterdayStr}`, "success");
        state.lastCheckDate = yesterdayStr;
        saveState();
        updateDebugPanel();
        debugLog(
          '‚úì Date set. Now click "Force Rollover" or wait up to 60s',
          "success"
        );
      }

      function toggleTestMode() {
        testMode = !testMode;
        debugLog(
          `üß™ Test mode ${testMode ? "ENABLED" : "DISABLED"}`,
          testMode ? "success" : "info"
        );
        updateDebugPanel();
      }

      // Auto-update debug panel every 5 seconds if open
      setInterval(() => {
        const panel = document.getElementById("debugPanel");
        if (panel && panel.classList.contains("show")) {
          updateDebugPanel();
        }
      }, 5000);

      // Initialize on load
      init();
    </script>
  </body>
</html>
